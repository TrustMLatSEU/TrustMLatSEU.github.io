<!DOCTYPE html>
<!-- Created by Deng-Bao Wang -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trustworthy Machine Learning Group</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>Trustworthy Machine Learning Group @ SEU</h1>
                    <p class="subtitle">Weekly Seminar Series</p>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div id="display-page">
            <div class="main-content">
                <aside class="sidebar">
                    <div class="about-section">
                        <h2 class="section-title">About Our Group</h2>
                        <div class="about-content">
                            <p>We are a research team focused on trustworthy machine learning, part of the PALM Lab in School of Computer Science and Engineering at Southeast University. We are particularly focused on uncertainty quantification in modern models.</p>
                            </div>
                        
                        <h3 class="about-subtitle">Related Topics</h3>
                        <ul class="research-areas">
                            <li>Uncertainty Calibration for Modern Deep Learning</li>
                            <li>Uncertainty Evaluation of (Multimodal) LLMs</li>
                            <li>Hallucination in Foundation Models</li>
                            <li>Out-of-Distribution Accuracy Prediction</li>
                            <li>Uncertainty Quantification in Embodied Intelligence</li>
                            <li>Trustworthy AI for Scientific Discovery</li>
                        </ul>
                        
                        <div class="tutorial-section">
                            <h3><i class="fas fa-info-circle"></i>What papers should you share?</h3>
                            <ul>
                                <li>Top conference papers from the past year, </li>
                                <li>highly influential works (e.g., 5000+ citations), </li>
                                <li>papers authored by your favorite researchers, </li>
                                <li>or those likely to spark discussion.</li>
                        </div>
                        <h3 class="about-subtitle">Useful Links</h3>
                        <ul class="research-areas">
                            <li><a href="https://bdcc.seu.edu.cn/4/23/list.html" target="_blank"> 东南大学大数据计算中心用户申请</a></li>
                            <li><a href="https://sc.seu.edu.cn/docs/index.html" target="_blank"> 东南大学大数据计算中心使用手册</a></li>
                            <li><a href="https://docs.google.com/document/d/10WwGb411SLdB4K71jUtA7Rdr94x3v5ZCevhbe07uR9c/edit?usp=drive_link" target="_blank"> V100 GPU服务器使用说明</a></li>
                            <li><a href="arxiv.html" target="_blank"> arXiv 论文智能推荐</a></li>
                        </ul>
                    </div>
                </aside>
                
                <main class="content-area">
                    <h2 class="section-title">Upcoming Presentation  <span id="next-date">Loading...</span></h2>
                        <div class="next-meeting-card">
                                <p><strong>Title: <a href="#" id="next-paper-link" target="_blank"><span id="next-title">Loading...</span></a></strong></p>
                                <p><strong>Conference:</strong> <span id="next-conference">Loading...</span></p>
                                <p><strong>Presenter:</strong> <span id="next-presenter">Loading...</span></p>
                                <p><strong>Location:</strong> Room 413, Computer Science Building, Jiulonghu Campus of Southeast University</p>
                                <p><strong>Tencent Meeting ID:</strong> <a href="https://meeting.tencent.com/dm/zy7FLyzPJmUT" target="_blank">#522-1446-6679</a> </p>
                        </div>

                    <h2 class="section-title">
                        Presentation Archive
                        <div class="filter-options">
                            <select id="sort-select">
                                <option value="date-desc">Sort by Date (Newest First)</option>
                                <option value="date-asc">Sort by Date (Oldest First)</option>
                                <option value="presenter">Sort by Presenter</option>
                            </select>
                            <input type="text" id="search-input" placeholder="Search presenter, title or conference">
                            <!-- 添加刷新按钮 -->
                            <button id="refresh-table" class="refresh-button" title="Refresh Data">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </h2>
                    
                    
                    <table class="archive-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Presenter</th>
                                <th>Title</th>
                                <th>Conference</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody id="archive-table-body">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                      <div class="pagination-controls">
                        <div class="pagination-buttons">
                            <button id="first-page" class="pagination-btn" title="First Page">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button id="prev-page" class="pagination-btn" title="Previous Page">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <span id="page-info" class="page-info">Page 1 of 1</span>
                            <button id="next-page" class="pagination-btn" title="Next Page">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button id="last-page" class="pagination-btn" title="Last Page">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>

                        <div class="items-per-page">
                            <span>Items per page:</span>
                            <select id="items-per-page">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        </div>                              
                </main>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>© 2025 TrustML Group at SEU &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; <!--Template by <a href="mailto:wangdb@seu.edu.cn">Deng-Bao Wang</a> &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; -->
            <i class="fas fa-database"></i> Powered by&nbsp; <a href="https://docs.google.com/spreadsheets/d/1gzMzanZzVq2nXOSCEo3brlErXrSFua0CGHk-2El5ExE" class="footer-link google-sheet" target="_blank"><i class="fas fa-table"></i> Google Sheet</a>&nbsp;&nbsp;&&nbsp;&nbsp;<a href="https://drive.google.com/drive/folders/19jk7dNUOjB9NDIfqxjR-wWxPJSnIe_0I?usp=sharing" class="footer-link google-drive" target="_blank"><i class="fab fa-google-drive"></i> Google Drive</a><!--&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Template by <a href="mailto:wangdb@seu.edu.cn">Deng-Bao Wang--><!--</a>-->
            </p>
        </div>
    </footer>

    <script>
        // Global variable to store meeting data
        let meetings = [];
        // 添加分页相关变量
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredMeetings = [];
        let nextMeetingId = null;

        // Google Sheets configuration
        const SHEET_ID = '1gzMzanZzVq2nXOSCEo3brlErXrSFua0CGHk-2El5ExE'; // 替换为你的Google Sheet ID
        const SHEET_NAME = 'presentation'; // 替换为你的工作表名称
        const API_KEY = 'AIzaSyBQzHLMvJg2E0YXzhswedNriodB0Pw8ykc'; // 替换为你的Google API密钥

        // Page elements
        const archiveTableBody = document.getElementById('archive-table-body');
        const sortSelect = document.getElementById('sort-select');
        const searchInput = document.getElementById('search-input');
        const refreshTableBtn = document.getElementById('refresh-table');
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners
            sortSelect.addEventListener('change', renderArchiveTable);
            searchInput.addEventListener('input', renderArchiveTable);
            
            // Load data from Google Sheet
            //loadDataFromGoogleSheet(); // 原始调用
            loadDataWithCaching(); // 使用缓存机制
            // 添加刷新按钮事件监听
            refreshTableBtn.addEventListener('click', refreshCacheAndData);

        });

        // 添加分页按钮事件
        document.getElementById('first-page').addEventListener('click', () => {
            currentPage = 1;
            renderArchiveTable();
        });
        
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderArchiveTable();
            }
        });
        
        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredMeetings.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderArchiveTable();
            }
        });
        
        document.getElementById('last-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredMeetings.length / itemsPerPage);
            currentPage = totalPages;
            renderArchiveTable();
        });
        
        // 每页显示条目数变化事件
        document.getElementById('items-per-page').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1; // 重置到第一页
            renderArchiveTable();
        });

        // Function to load data from Google Sheet
        function loadDataFromGoogleSheet() {
            // Show loading state
            archiveTableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            正在从Google Sheet加载会议数据...
                        </div>
                    </td>
                </tr>
            `;
            
            // Construct the Google Sheets API URL
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法从Google Sheet加载数据');
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        // Process the Google Sheet data
                        meetings = processGoogleSheetData(data.values);
                        renderNextMeeting();
                        renderArchiveTable();
                    } catch (error) {
                        showError('处理Google Sheet数据时出错: ' + error.message);
                    }
                })
                .catch(error => {
                    showError('加载Google Sheet数据时出错: ' + error.message);
                });
        }

        // Process Google Sheet data into our meeting format
        function processGoogleSheetData(rows) {
            if (!rows || rows.length < 2) {
                throw new Error('Google Sheet中没有足够的数据');
            }
            
            const headers = rows[0];
            const result = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length === 0) continue;
                
                const meeting = {};
                headers.forEach((header, index) => {
                    meeting[header] = row[index] || '';
                });
                result.push(meeting);
            }
            
            if (result.length === 0) {
                throw new Error('Google Sheet中没有有效数据');
            }
            
            return result;
        }

        // 添加缓存相关变量
        const CACHE_KEY = 'trustml_meetings_cache';
        const CACHE_DURATION = 30 * 60 * 1000; // 30分钟缓存 (单位: 毫秒)

        // Function to load data with caching
        function loadDataWithCaching() {
            // 检查本地是否有有效缓存
            const cachedData = getCachedData();
            
            if (cachedData && cachedData.length > 0) {
                // 使用缓存数据
                meetings = cachedData;
                renderNextMeeting();
                renderArchiveTable();
                
                // 在后台更新缓存（如果过期）
                if (isCacheExpired()) {
                    fetchDataFromGoogleSheet(true);
                }
            } else {
                // 没有缓存或缓存过期，直接从Google Sheet获取
                fetchDataFromGoogleSheet(false);
            }
        }

        // 获取缓存数据
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const parsed = JSON.parse(cached);
                if (!parsed || !parsed.data || !parsed.timestamp) return null;
                
                // 检查缓存是否过期
                const currentTime = new Date().getTime();
                if (currentTime - parsed.timestamp > CACHE_DURATION) {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
                
                return parsed.data;
            } catch (e) {
                console.error('Error reading cache:', e);
                return null;
            }
        }

        // 存储数据到缓存
        function cacheData(data) {
            try {
                const cache = {
                    timestamp: new Date().getTime(),
                    data: data
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) {
                console.error('Error caching data:', e);
            }
        }

        // 检查缓存是否过期
        function isCacheExpired() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return true;
            
            try {
                const parsed = JSON.parse(cached);
                if (!parsed || !parsed.timestamp) return true;
                
                const currentTime = new Date().getTime();
                return currentTime - parsed.timestamp > CACHE_DURATION;
            } catch (e) {
                return true;
            }
        }

        // 更新后的数据加载函数
        function fetchDataFromGoogleSheet(silentUpdate = false) {
            if (!silentUpdate) {
                // 显示加载状态
                archiveTableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                正在从Google Sheet加载会议数据...
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法从Google Sheet加载数据');
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        meetings = processGoogleSheetData(data.values);
                        cacheData(meetings); // 缓存数据
                        
                        if (!silentUpdate) {
                            renderNextMeeting();
                            renderArchiveTable();
                        }
                    } catch (error) {
                        if (!silentUpdate) {
                            showError('处理Google Sheet数据时出错: ' + error.message);
                        }
                    }
                })
                .catch(error => {
                    if (!silentUpdate) {
                        // 尝试使用缓存作为回退
                        const cached = getCachedData();
                        if (cached && cached.length > 0) {
                            meetings = cached;
                            renderNextMeeting();
                            renderArchiveTable();
                            showWarning('无法连接到Google Sheet。显示缓存数据。');
                        } else {
                            showError('加载Google Sheet数据时出错: ' + error.message);
                        }
                    }
                });
        }

        // 添加警告提示
        function showWarning(message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-message';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                ${message}
            `;
            
            // 在表格上方显示警告
            const table = document.querySelector('.archive-table');
            if (table && table.parentNode) {
                table.parentNode.insertBefore(warningDiv, table);
            }
            
            // 3秒后淡出
            setTimeout(() => {
                warningDiv.style.transition = 'opacity 1s';
                warningDiv.style.opacity = '0';
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.parentNode.removeChild(warningDiv);
                    }
                }, 1000);
            }, 3000);
        }
        // Render meeting archive table
        function renderArchiveTable() {
            if (meetings.length === 0) {
                archiveTableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                没有会议记录可显示。
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get search keyword
            const searchTerm = searchInput.value.toLowerCase();
            
            // Get sort option
            const sortOption = sortSelect.value;
            
            // Filter meetings
            let filteredByDate = meetings.filter(meeting => {
                const meetingId = meeting.id || `${meeting.Date}-${meeting.Title}`;
                return meetingId !== nextMeetingId;
            });
            
            // 第二次过滤：基于搜索条件
            filteredMeetings = filteredByDate.filter(meeting => 
                (meeting.Presenter && meeting.Presenter.toLowerCase().includes(searchTerm)) ||
                (meeting.Title && meeting.Title.toLowerCase().includes(searchTerm)) ||
                (meeting.Conference && meeting.Conference.toLowerCase().includes(searchTerm))
            );
            
            // Apply sorting
            switch(sortOption) {
                case 'date-desc':
                    filteredMeetings.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                    break;
                case 'date-asc':
                    filteredMeetings.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    break;
                case 'presenter':
                    filteredMeetings.sort((a, b) => a.Presenter.localeCompare(b.Presenter));
                    break;
            }
            
            // If no search results
            if (filteredMeetings.length === 0) {
                archiveTableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="error-message">
                                <i class="fas fa-search"></i>
                                没有匹配的会议记录。
                            </div>
                        </td>
                    </tr>
                `;
                
                // 更新分页控件为空状态
                updatePaginationControls(0);
                return;
            }
            
            // 计算总页数
            const totalPages = Math.ceil(filteredMeetings.length / itemsPerPage);
            
            // 确保当前页不超过总页数
            if (currentPage > totalPages) {
                currentPage = totalPages > 0 ? totalPages : 1;
            }
            
            // 更新分页控件
            updatePaginationControls(totalPages);
            
            // 获取当前页的数据
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredMeetings.length);
            const pageMeetings = filteredMeetings.slice(startIndex, endIndex);

            let tableHTML = '';
            
            // 使用pageMeetings而不是filteredMeetings
            pageMeetings.forEach(meeting => {
                const date = new Date(meeting.Date);
                const formattedDate = date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                
                tableHTML += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td><strong>${meeting.Presenter || ''}</strong></td>
                        <td>${meeting.Title || ''}</td>
                        <td>${meeting.Conference + ' ' + meeting.Year || ''}</td>
                        <td>
                            <a href="${meeting['Slides Link']}" class="material-link" target="_blank"> &nbspSlides</a>
                        </td>
                    </tr>
                `;
            });
            
            archiveTableBody.innerHTML = tableHTML;
        }

        // 添加分页控件更新函数
        function updatePaginationControls(totalPages) {
            const pageInfo = document.getElementById('page-info');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            // 更新按钮状态
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('last-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        // 添加renderNextMeeting函数
        function renderNextMeeting() {
            if (meetings.length === 0) return;
            
            // 找到日期最晚的会议
            const nextMeeting = meetings.reduce((latest, current) => {
                const currentDate = new Date(current.Date);
                const latestDate = new Date(latest.Date);
                return currentDate > latestDate ? current : latest;
            }, meetings[0]);
            
            // 更新DOM元素
            const date = new Date(nextMeeting.Date);
            const formattedDate = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            document.getElementById('next-date').textContent = formattedDate + ' 14:00';
            document.getElementById('next-presenter').textContent = nextMeeting.Presenter || '';
            document.getElementById('next-title').textContent = nextMeeting.Title || '';
            document.getElementById('next-conference').textContent = nextMeeting.Conference + ' ' + nextMeeting.Year || '';
            
            const paperLink = document.getElementById('next-paper-link');
            if (nextMeeting['Paper Link']) {
                paperLink.href = nextMeeting['Paper Link'];
            } else {
                paperLink.style.display = 'none';
            }
            if (nextMeeting) {
                nextMeetingId = nextMeeting.id || `${nextMeeting.Date}-${nextMeeting.Title}`;
            }
        }

        // 刷新缓存和数据的函数
        function refreshCacheAndData() {
            // 清除缓存
            localStorage.removeItem(CACHE_KEY);
            
            // 显示加载状态
            archiveTableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            正在刷新数据...
                        </div>
                    </td>
                </tr>
            `;
            
            // 重新加载数据
            fetchDataFromGoogleSheet(false);
            // 确保刷新 Upcoming Presentation
            renderNextMeeting();
        }

        function showError(message) {
            archiveTableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${message}
                        </div>
                    </td>
                </tr>
            `;
        }
    </script>
</body>
</html>